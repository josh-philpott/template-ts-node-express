---
name: Build and Deploy To App Engine

on:
  push:
    tags: releases/[1-9]+.[0-9]+.[0-9]+
    branches: main

permissions:
  id-token: write # This is required for requesting the JWT google-github-actions/auth@v2
  contents: read # This is required for checking out the repository

jobs:
  build:
    uses: "$GITHUB_ACTIONS_REPOSITORY/.github/workflows/build.yml@main"

  deploy:
    needs:
      - build
    
    - name: "ðŸ“‚ download build artifacts"
        uses: actions/download-artifact@v2
        with:
          name: build
          path: build
    - id: "auth"
      uses: "google-github-actions/auth@v2"
      with:
        credentials_json: ${{ secrets.GCLOUD_SERVICE_ACCOUNT_KEY_JSON }}
        service_account: ${{ vars.GCLOUD_SERVICE_ACCOUNT }}

    - id: "deploy"
      uses: "google-github-actions/deploy-appengine@v2"
      with:
        deliverables: app.yaml
        project_id: ${{ vars.GCLOUD_PROJECT_ID }}
