---
name: Release

on:
  push:
    tags: ["releases/[1-9]+.[0-9]+.[0-9]+"]

permissions:
  id-token: write # This is required for requesting the JWT google-github-actions/auth@v2
  contents: read # This is required for checking out the repository

jobs:
  set-artifact-name:
    runs-on: ubuntu-latest
    outputs:
      artifact-name: ${{ steps.step1.outputs.ARTIFACT_NAME }}
    steps:
      - id: step1
        run: |
          TAG=${{ github.ref_name }} 
          echo "ARTIFACT_NAME=${TAG////-}" >> "$GITHUB_OUTPUT"
  build:
    needs:
      - set-artifact-name
    uses: ./.github/workflows/build.yml
    with:
      artifact-id: ${{needs.set-artifact-name.outputs.artifact-name}}
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs:
      - set-artifact-name
      - build
    steps:
      - name: "ðŸ“‚ download build artifacts"
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}

      - id: "auth"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: ${{ secrets.GCLOUD_SERVICE_ACCOUNT_KEY_JSON }}
          service_account: ${{ vars.GCLOUD_SERVICE_ACCOUNT }}

      - id: "deploy"
        uses: "google-github-actions/deploy-appengine@v2"
        with:
          deliverables: app.yaml
          project_id: ${{ vars.GCLOUD_PROJECT_ID }}
